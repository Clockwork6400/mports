PORTNAME=	pear
PORTVERSION=	1.10.6
PORTREVISION=	1
CATEGORIES=	devel
MASTER_SITES=	http://mirror.bsdproject.de/ \
	LOCAL/joneum
PKGNAMEPREFIX=	${PHP_PKGNAMEPREFIX}

MAINTAINER=	ports@MidnightBSD.org
COMMENT=	PEAR framework for PHP

LICENSE=	php

USES=		cpe php:cli,flavors tar:bzip2
CPE_VENDOR=	php
NO_BUILD=	yes
NO_ARCH=	yes
NO_TEST=	yes

USE_PHP=	pcre:build xml:build zlib:build

PEARDIR=	${PREFIX}/share/pear

OPTIONS_DEFINE=	DOCS

post-patch:
	@${MKDIR} ${FAKE_DESTDIR}${PEARDIR}
	@${REINPLACE_CMD} -e "s|%%PREFIX%%|${TRUE_PREFIX}|" \
		-e "s|%%BUNDLEDIR%%|${WRKSRC}/go-pear-bundle|" \
		-e "s|%%TMPDIR%%|/tmp/pear|" \
		${WRKSRC}/go-pear
	@cd ${WRKSRC}/go-pear-bundle && ${MKDIR} tmp && ${TAR} -C tmp -xf PEAR-${PORTVERSION}.tar
	@cd ${WRKSRC}/go-pear-bundle/tmp/PEAR-${PORTVERSION} && ${PATCH} -s -p0 < ${FILESDIR}/extra-patch-PEAR-Config.php
	@${RM} ${WRKSRC}/go-pear-bundle/tmp/PEAR-${PORTVERSION}/PEAR/Config.php.orig
	@${MD5} -q ${WRKSRC}/go-pear-bundle/tmp/PEAR-${PORTVERSION}/PEAR/Config.php > ${WRKSRC}/Config.php.md5
	@cd ${WRKSRC}/go-pear-bundle/tmp && ${TAR} -cf ../PEAR-${PORTVERSION}.tar PEAR-${PORTVERSION} package.xml

do-install:
	@cd ${WRKSRC} && ${SETENV} DESTDIR=${FAKE_DESTDIR} ${LOCALBASE}/bin/php -q ./go-pear
	@${SED} -i "" "s|<?php|<?php dl('pcre.so'); dl('xml.so');|" \
		${STAGEDIR}${PEARDIR}/peclcmd.php
# pear violates stage when staging as root, hide this
.if defined(PACKAGE_BUILDING)
	@${RM} -r ${TRUE_PREFIX}/share/pear
.endif
# Clean up orphans re-generated by pkg-install
	-${RM} -r ${STAGEDIR}${PEARDIR}/.depdb ${STAGEDIR}${PEARDIR}/.depdblock ${STAGEDIR}${PEARDIR}/.filemap ${STAGEDIR}${PEARDIR}/.lock

.include <bsd.port.mk>
